# 2021-highload-dht
Курсовой проект 2021 года [курса](https://polis.mail.ru/curriculum/program/discipline/1257/) "Проектирование высоконагруженных систем" в [Технополис](https://polis.mail.ru).

## Этап 1. HTTP + storage (deadline 2021-09-29 23:59:59 MSK)

### Задание

Проведите нагрузочное тестирование с помощью [wrk](https://github.com/giltene/wrk2) в **одно соединение**:
* `PUT` запросами на **стабильной** нагрузке (`wrk` должен обеспечивать заданный с помощью `-R` rate запросов)
* `GET` запросами на **стабильной** нагрузке по **наполненной** БД

Приложите полученный консольный вывод `wrk` для обоих видов нагрузки.

Отпрофилируйте приложение (CPU и alloc) под `PUT` и `GET` нагрузкой с помощью [async-profiler](https://github.com/jvm-profiling-tools/async-profiler).
Приложите FlameGraph `cpu`/`alloc` для `PUT`/`GET` нагрузки.

**Объясните** результаты нагрузочного тестирования и профилирования.


### Тестирование PUT запросами
Для нагрузочного тестирования PUT запросами запустим утилиту wrk2 следующей командой.
```
$ wrk2 -c 1 -d 1m -t 1 -s wrk/put.lua -R 10k -L http://localhost:8080
```

Для формирования запроса используется скрипт put.lua

```
counter = 0

request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "PUT"
    wrk.body = "value" .. counter
    counter = counter + 1
    return wrk.format(nil, path)
end
```

Результаты тестирования следующие

```
ogamoga@ubuntu:~/Desktop/2021-highload-dht$ wrk2 -c 1 -d 1m -t 1 -s wrk/put.lua -R 10k -L http://localhost:8080
Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 25.854ms, rate sampling interval: 145ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   221.86ms  446.52ms   1.64s    85.57%
    Req/Sec    10.03k     5.21k   36.46k    82.85%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   20.48ms
 75.000%   98.30ms
 90.000%    1.09s 
 99.000%    1.60s 
 99.900%    1.64s 
 99.990%    1.64s 
 99.999%    1.64s 
100.000%    1.65s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.022     0.000000            5         1.00
       1.029     0.100000        50025         1.11
       1.811     0.200000        99951         1.25
       6.631     0.300000       149909         1.43
      13.343     0.400000       199869         1.67
      20.479     0.500000       249934         2.00
      25.343     0.550000       274909         2.22
      31.599     0.600000       299829         2.50
      41.215     0.650000       324795         2.86
      55.775     0.700000       349818         3.33
      98.303     0.750000       374762         4.00
     126.591     0.775000       387268         4.44
     166.271     0.800000       399765         5.00
     357.887     0.825000       412241         5.71
     602.623     0.850000       424731         6.67
     815.615     0.875000       437214         8.00
     961.023     0.887500       443463         8.89
    1091.583     0.900000       449705        10.00
    1218.559     0.912500       455969        11.43
    1312.767     0.925000       462293        13.33
    1395.711     0.937500       468457        16.00
    1418.239     0.943750       471579        17.78
    1429.503     0.950000       474818        20.00
    1457.151     0.956250       477831        22.86
    1507.327     0.962500       480996        26.67
    1528.831     0.968750       484133        32.00
    1537.023     0.971875       485637        35.56
    1550.335     0.975000       487346        40.00
    1559.551     0.978125       488746        45.71
    1571.839     0.981250       490449        53.33
    1581.055     0.984375       491865        64.00
    1586.175     0.985938       492762        71.11
    1591.295     0.987500       493491        80.00
    1596.415     0.989062       494352        91.43
    1600.511     0.990625       495044       106.67
    1605.631     0.992188       495845       128.00
    1607.679     0.992969       496177       142.22
    1609.727     0.993750       496574       160.00
    1612.799     0.994531       497101       182.86
    1614.847     0.995313       497335       213.33
    1617.919     0.996094       497854       256.00
    1618.943     0.996484       497987       284.44
    1620.991     0.996875       498126       320.00
    1625.087     0.997266       498354       365.71
    1627.135     0.997656       498522       426.67
    1630.207     0.998047       498767       512.00
    1631.231     0.998242       498849       568.89
    1632.255     0.998437       498952       640.00
    1633.279     0.998633       499052       731.43
    1634.303     0.998828       499119       853.33
    1636.351     0.999023       499247      1024.00
    1636.351     0.999121       499247      1137.78
    1637.375     0.999219       499330      1280.00
    1638.399     0.999316       499440      1462.86
    1638.399     0.999414       499440      1706.67
    1638.399     0.999512       499440      2048.00
    1639.423     0.999561       499508      2275.56
    1639.423     0.999609       499508      2560.00
    1639.423     0.999658       499508      2925.71
    1640.447     0.999707       499569      3413.33
    1640.447     0.999756       499569      4096.00
    1640.447     0.999780       499569      4551.11
    1641.471     0.999805       499611      5120.00
    1641.471     0.999829       499611      5851.43
    1641.471     0.999854       499611      6826.67
    1642.495     0.999878       499636      8192.00
    1642.495     0.999890       499636      9102.22
    1642.495     0.999902       499636     10240.00
    1642.495     0.999915       499636     11702.86
    1642.495     0.999927       499636     13653.33
    1643.519     0.999939       499653     16384.00
    1643.519     0.999945       499653     18204.44
    1643.519     0.999951       499653     20480.00
    1643.519     0.999957       499653     23405.71
    1644.543     0.999963       499667     27306.67
    1644.543     0.999969       499667     32768.00
    1644.543     0.999973       499667     36408.89
    1644.543     0.999976       499667     40960.00
    1644.543     0.999979       499667     46811.43
    1644.543     0.999982       499667     54613.33
    1644.543     0.999985       499667     65536.00
    1644.543     0.999986       499667     72817.78
    1644.543     0.999988       499667     81920.00
    1644.543     0.999989       499667     93622.86
    1645.567     0.999991       499672    109226.67
    1645.567     1.000000       499672          inf
#[Mean    =      221.856, StdDeviation   =      446.520]
#[Max     =     1644.544, Total count    =       499672]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599443 requests in 1.00m, 38.30MB read
Requests/sec:   9990.91
Transfer/sec:    653.70KB
```

Сервер выдерживает заданную частоту запросов. Средняя задержка - 221.86ms, максимальная - 1.65s. Между 90% и 100% происходит монотонное увеличение задержки.
Присутствует резкий рост задержки между 75% и 90%. Возможно, огромная разница объясняется тем, что для малой части запросов приходится запускать flush - медленное
взаимодействие с диском. В то время, как основная часть запросов взаимодействует только с быстрой оперативной памятью.

При этой нагрузке произведем профилирование используемых ресурсов процессора и памяти с помощью утилиты async-profiler.

[Результаты профилирования CPU](./pictures/putcpu.html)

Можно заметить, что работа GC заняла 5.85% процессорного времени. Это нормальный показатель, генерируется допустимое количество мусора. Можно не оптимизировать.

Основную часть процессорного времени использует метод HttpSession.sendResponse() - 70.77%. Полагаю, это нормальные показатели для сетевого взаимодействия.
Было бы целесообразно обрабатывать сетевые запросы несколькими потоками, это должно значительно уменьшить задержку.
Возможно, имеет смысл отказаться от http протокола в пользу более эффективного/лаконичного.
Это несколько уменьшит время парсинга запросов и формирования ответов.

Методы LsmDao (а именно метод upsert) занимают 18.18% процессорного времени. Работа с in memory storage отнимает ничтожную часть времени (1.05%) - 
в оптимизации не нуждается.
Очевидно, все упирается в метод flush() - 17.05%. Для уменьшения задержки целесообразно запускать flush асинхронно. Сама запись на диск, думаю, не имеет
потенциала для оптимизации.

[Результаты профилирования памяти](./pictures/putmem.html)

Ощутимая часть памяти уходит на парсинг http запроса - 20.20%. Это связано с выбором http протокола и, думаю, не удастся оптимизировать.

При использовании ServiceImpl.put уходит 35.98%. Аллоцируется много байтбуфферов. Возможно, стоит оптимизировать их.

Остальные аллокации связаны с сетевым взаимодействием.

### Тестирование GET запросами
Для нагрузочного тестирования GET запросами запустим утилиту wrk2 следующей командой
```
$ wrk2 -c 1 -d 1m -t 1 -s wrk/get.lua -R 10k -L http://localhost:8080
```

Для формирования запроса используется скрипт get.lua

```
counter = 0

request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "GET"
    counter = counter + 1
    return wrk.format(nil, path)
end
```

Результаты тестирования следующие

```
ogamoga@ubuntu:~/Desktop/2021-highload-dht$ wrk2 -c 1 -d 1m -t 1 -s wrk/get.lua -R 10k -L http://localhost:8080
Running 1m test @ http://localhost:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 26.279ms, rate sampling interval: 153ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   336.96ms  514.83ms   1.95s    81.80%
    Req/Sec    10.04k     4.04k   27.14k    82.21%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%   80.25ms
 75.000%  313.60ms
 90.000%    1.29s 
 99.000%    1.90s 
 99.900%    1.94s 
 99.990%    1.95s 
 99.999%    1.95s 
100.000%    1.95s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.026     0.000000            1         1.00
       1.433     0.100000        50026         1.11
      10.295     0.200000       100022         1.25
      26.207     0.300000       150029         1.43
      46.687     0.400000       200012         1.67
      80.255     0.500000       250044         2.00
     102.783     0.550000       275031         2.22
     142.207     0.600000       300028         2.50
     199.167     0.650000       325070         2.86
     244.991     0.700000       350045         3.33
     313.599     0.750000       375033         4.00
     378.111     0.775000       387545         4.44
     537.599     0.800000       400022         5.00
     993.791     0.825000       412626         5.71
    1143.807     0.850000       425092         6.67
    1216.511     0.875000       437534         8.00
    1255.423     0.887500       443782         8.89
    1285.119     0.900000       450135        10.00
    1320.959     0.912500       456339        11.43
    1353.727     0.925000       462558        13.33
    1403.903     0.937500       468807        16.00
    1430.527     0.943750       471988        17.78
    1452.031     0.950000       475030        20.00
    1518.591     0.956250       478151        22.86
    1574.911     0.962500       481289        26.67
    1686.527     0.968750       484481        32.00
    1703.935     0.971875       486023        35.56
    1751.039     0.975000       487527        40.00
    1790.975     0.978125       489087        45.71
    1817.599     0.981250       490780        53.33
    1841.151     0.984375       492229        64.00
    1856.511     0.985938       493001        71.11
    1883.135     0.987500       493792        80.00
    1895.423     0.989062       494629        91.43
    1901.567     0.990625       495361       106.67
    1906.687     0.992188       496166       128.00
    1908.735     0.992969       496552       142.22
    1911.807     0.993750       497029       160.00
    1914.879     0.994531       497376       182.86
    1917.951     0.995313       497754       213.33
    1922.047     0.996094       498079       256.00
    1925.119     0.996484       498292       284.44
    1927.167     0.996875       498472       320.00
    1930.239     0.997266       498704       365.71
    1932.287     0.997656       498852       426.67
    1935.359     0.998047       499067       512.00
    1937.407     0.998242       499192       568.89
    1938.431     0.998437       499264       640.00
    1940.479     0.998633       499380       731.43
    1942.527     0.998828       499503       853.33
    1943.551     0.999023       499562      1024.00
    1944.575     0.999121       499641      1137.78
    1944.575     0.999219       499641      1280.00
    1945.599     0.999316       499728      1462.86
    1946.623     0.999414       499767      1706.67
    1947.647     0.999512       499800      2048.00
    1948.671     0.999561       499850      2275.56
    1948.671     0.999609       499850      2560.00
    1949.695     0.999658       499900      2925.71
    1949.695     0.999707       499900      3413.33
    1950.719     0.999756       499928      4096.00
    1950.719     0.999780       499928      4551.11
    1950.719     0.999805       499928      5120.00
    1951.743     0.999829       499975      5851.43
    1951.743     0.999854       499975      6826.67
    1951.743     0.999878       499975      8192.00
    1951.743     0.999890       499975      9102.22
    1951.743     0.999902       499975     10240.00
    1952.767     0.999915       499993     11702.86
    1952.767     0.999927       499993     13653.33
    1952.767     0.999939       499993     16384.00
    1953.791     0.999945       500023     18204.44
    1953.791     1.000000       500023          inf
#[Mean    =      336.956, StdDeviation   =      514.828]
#[Max     =     1952.768, Total count    =       500023]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  599492 requests in 1.00m, 42.19MB read
  Non-2xx or 3xx responses: 49
Requests/sec:   9991.56
Transfer/sec:    720.07KB
```


Сервер выдерживает заданную частоту запросов. Средняя задержка - 336.96ms, максимальная - 1.95s. Между 90% и 100% происходит монотонное увеличение задержки, как и с 
put запросами.

Однако в этом случае скачок между 75% и 90% не такой резкий. Это объясняется тем, что выполнить get запрос 
в принципе сложнее чем put, и уже на 75% время ответа ощутимо.

Формирование ответа по get запросу занимает больше времени, так как приходится передавать результат в теле http запроса.

Также большей части запросов приходится взаимодействовать с диском, довольно затратно слияние итераторов.

По вышеназванным причинам на каждом из рассмотренных перцентилей время ответа get запроса больше, чем у put запроса.

При этой нагрузке произведем профилирование используемых ресурсов процессора и памяти с помощью утилиты async-profiler.

[Результаты профилирования CPU](./pictures/getcpu.html)

Работа GC заняла 5.60% процессорного времени. Все нормально.

Опять же, подавляющая часть процессорного времени занял метод HttpSession.sendResponse() - 79.50%. Это больше, чем
у put запросов (70.77%). Связано с тем, что мы передаем результат в тело ответа. В остальном все аналогично.

Взаимодействие с DAO (DaoImpl.getRange()) занимает 11.60% процессорного времени. Подавляющую часть этого времени 
занимает, SSTable.range() - 8.81%.
LsmDAO.merge занимает только 0.27% времени и не нуждается в оптимизации.

[Результаты профилирования памяти](./pictures/getmem.html)

Основная часть памяти уходит на ServiceImpl.get - 89.46%.
Много памяти уходит на PeekingIterator (14.03%), LsmDao.merge (31.58%) и SSTable.range(28.03%)
